{{- $.Scratch.Add "index" slice -}}
{{- range site.RegularPages -}}
    {{- if and (not .Params.searchHidden) (ne .Layout "archives") (ne .Layout "search") }}
        {{- /* 处理 summary */}}
        {{- $summary := .Summary | replaceRE `<pre[^>]*>[\s\S]*?</pre>` "" | replaceRE `<code[^>]*>[\s\S]*?</code>` "" | plainify -}}

        {{- /* 处理 content */}}
        {{- $content := .Content | replaceRE `<pre[^>]*>[\s\S]*?</pre>` "" | replaceRE `<code[^>]*>[\s\S]*?</code>` "" | plainify -}}

        {{- /* 确保 tags 是数组 */}}
        {{- $tags := .Params.tags | default (slice) -}}

        {{- /* 加入索引，所有字符串先 safeJS 防止 JSON 崩溃 */}}
        {{- $.Scratch.Add "index" (dict 
            "title" (.Title | safeJS) 
            "content" ($content | safeJS) 
            "permalink" (.Permalink | safeJS)
            "summary" ($summary | safeJS) 
            "tags" $tags
        ) -}}
    {{- end }}
{{- end -}}

{{- /* 最终输出 JSON */}}
{{- $.Scratch.Get "index" | jsonify -}}